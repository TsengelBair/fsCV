const TelegramApi = require("node-telegram-bot-api");
const { getSchedule, formatSchedule } = require("./mongodb");

require("dotenv").config();

function setupBot() {
  const token = process.env.BOT_TOKEN;

  if (!token) {
    console.log("Invalid token");
    return;
  }

  const bot = new TelegramApi(token, { polling: true });

  const commands = [
    { command: "/start", description: "–ù–∞—á–∞—Ç—å" },
    {
      command: "/schedule",
      description: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ",
      text: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π.",
    },
    {
      command: "/chat",
      description: "–°–≤—è–∑–∞—Ç—å—Å—è",
      text: "–°–≤—è–∑–∞—Ç—å—Å—è —Å —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–º.",
    },
    {
      command: "/price",
      description: "–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–Ω—è—Ç–∏–π",
      text: "–£–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–Ω—è—Ç–∏–π.",
    },
  ];

  bot.setMyCommands(commands);

  bot.on("message", async (msg) => {
    const text = msg.text;
    const chatId = msg.chat.id;

    if (text === "/start") {
      const username = msg.from.first_name || "–¥–æ—Ä–æ–≥–æ–π –≥–æ—Å—Ç—å";
      const welcomeMessage = `
      –ü—Ä–∏–≤–µ—Ç, ${username}! üëã –Ø - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ë–∞–∏—Ä–∞, –≥–æ—Ç–æ–≤—ã–π –ø–æ–º–æ—á—å —Ç–µ–±–µ –≤ —É—á–µ–±–µ! üìö‚ú®
      
      –° –º–æ–µ–π –ø–æ–º–æ—â—å—é —Ç—ã —Å–º–æ–∂–µ—à—å:
      üìå –ü–æ–ª—É—á–∞—Ç—å —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è –ø–æ —Ç—Ä—É–¥–Ω—ã–º —Ç–µ–º–∞–º –∏ –≤–æ–ø—Ä–æ—Å–∞–º.
      üìå –†–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤–º–µ—Å—Ç–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏.
      üìå –ü–æ–ª—É—á–∞—Ç—å —Å–æ–≤–µ—Ç—ã –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º.
      üìå –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é —É—á–µ–±—É –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å.
      
      –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–ø—Ä–æ—Å, –∏ —è —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É —Ç–µ–±–µ –≤ –æ–±—É—á–µ–Ω–∏–∏. –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Å—è —Å–æ–æ–±—â–∏—Ç—å –º–Ω–µ –æ–± —ç—Ç–æ–º!
      
      –£–¥–∞—á–∏ –≤ —É—á–µ–±–µ, –∏ –¥–∞–≤–∞–π –≤–º–µ—Å—Ç–µ –¥–æ—Å—Ç–∏–≥–Ω–µ–º –≤–µ–ª–∏–∫–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤! üí™üéâ
      
      –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ /commands.
    `;
      await bot.sendMessage(chatId, welcomeMessage);
    } else if (text === "/schedule") {
      try {
        const schedule = await getSchedule();
        const formattedSchedule = formatSchedule(schedule);
        bot.sendMessage(chatId, formattedSchedule);
      } catch (err) {
        console.error(err);
        bot.sendMessage(
          chatId,
          "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        );
      }
    } else if (text === "/commands") {
      const commandsMessage = "–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:";
      bot.sendMessage(chatId, commandsMessage, {
        reply_markup: {
          keyboard: commands.map((cmd) => [{ text: cmd.command }]),
          resize_keyboard: true,
        },
      });
    } else if (text === "/chat") {
      const chatMessage =
        "–î–ª—è —Å–≤—è–∑–∏ —Å–æ –º–Ω–æ–π –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: [–ù–∞–∂–º–∏ —Å—é–¥–∞](https://t.me/BairTsengel)";
      bot.sendMessage(chatId, chatMessage, { parse_mode: "Markdown" });
    } else if (text === "/price") {
      const priceMessage = `
      –î–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ:
          1-4 –∫–ª–∞—Å—Å—ã: 500 —Ä—É–±–ª–µ–π
          5-6 –∫–ª–∞—Å—Å—ã: 600 —Ä—É–±–ª–µ–π
          7-8 –∫–ª–∞—Å—Å—ã: 800 —Ä—É–±–ª–µ–π
          9-11 –∫–ª–∞—Å—Å—ã: 1000 —Ä—É–±–ª–µ–π
          
      –û—á–Ω–æ:
          1-4 –∫–ª–∞—Å—Å—ã: 900 —Ä—É–±–ª–µ–π
          5-6 –∫–ª–∞—Å—Å—ã: 1000 —Ä—É–±–ª–µ–π
          7-8 –∫–ª–∞—Å—Å—ã: 1300 —Ä—É–±–ª–µ–π
          9-11 –∫–ª–∞—Å—Å—ã: 1500 —Ä—É–±–ª–µ–π
          
      –°—Ç—É–¥–µ–Ω—Ç—ã 1 - 4 –∫—É—Ä—Å–æ–≤: –æ—Ç 1500
      (–≤—ã—Å—à–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, —Ç–µ–æ—Ä–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤, –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, —Ç–µ–æ—Ä–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–≥–æ, –º–µ—Ç–æ–¥—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
          
      –®–∞—Ö–º–∞—Ç—ã: –æ—Ç 1000
          
      –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–º —É—á–µ–Ω–∏–∫–∞–º –∏–¥—É—Ç –±–æ–Ω—É—Å—ã –≤ –≤–∏–¥–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è (–∫–∞–∂–¥–æ–µ 10-–æ–µ)
          `;
      bot.sendMessage(chatId, priceMessage);
    }
  });
}

module.exports = setupBot;
